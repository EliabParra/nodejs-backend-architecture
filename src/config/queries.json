{
    "security": {
        "getUser": "select u.user_id, u.username as user_na, u.email as user_em, u.email_verified_at, u.password_hash as user_pw, up.profile_id from security.users u inner join security.user_profiles up on up.user_id = u.user_id where u.username = $1",
        "getUserByUsername": "select u.user_id, u.username as user_na, u.email as user_em, u.email_verified_at, u.password_hash as user_pw, up.profile_id from security.users u inner join security.user_profiles up on up.user_id = u.user_id where u.username = $1",
        "getUserByEmail": "select u.user_id, u.username as user_na, u.email as user_em, u.email_verified_at, u.password_hash as user_pw, up.profile_id from security.users u inner join security.user_profiles up on up.user_id = u.user_id where u.email = $1",

        "getUserBaseByUsername": "select user_id, username as user_na, email as user_em, email_verified_at from security.users where username = $1",
        "getUserBaseByEmail": "select user_id, username as user_na, email as user_em, email_verified_at from security.users where email = $1",
        "insertUser": "insert into security.users (username, email, password_hash) values ($1, $2, $3) returning user_id",
        "upsertUserProfile": "insert into security.user_profiles (user_id, profile_id) values ($1, $2) on conflict (user_id) do update set profile_id = excluded.profile_id",
        "setUserEmailVerified": "update security.users set email_verified_at = now(), updated_at = now() where user_id = $1 and email_verified_at is null",

        "getActiveUserDeviceByUserAndTokenHash": "select user_device_id as device_id from security.user_devices where user_id = $1 and device_token_hash = $2 and revoked_at is null",
        "touchUserDevice": "update security.user_devices set last_used_at = now(), user_agent = $3, ip = $4 where user_id = $1 and device_token_hash = $2 and revoked_at is null",
        "upsertUserDevice": "insert into security.user_devices (user_id, device_token_hash, created_at, last_used_at, user_agent, ip) values ($1, $2, now(), now(), $3, $4) on conflict (device_token_hash) do update set last_used_at = now(), revoked_at = null returning user_device_id as device_id",

        "insertLoginChallenge": "insert into security.login_challenges (user_id, token_hash, code_hash, created_at, expires_at, request_ip, user_agent) values ($1, $2, $3, now(), now() + ($4 || ' seconds')::interval, $5, $6) returning login_challenge_id as challenge_id",
        "getLoginChallengeByTokenHash": "select lc.login_challenge_id as challenge_id, lc.user_id, lc.code_hash, lc.expires_at, lc.verified_at, lc.attempt_count, u.username as user_na, u.email as user_em, u.email_verified_at, up.profile_id from security.login_challenges lc inner join security.users u on u.user_id = lc.user_id inner join security.user_profiles up on up.user_id = u.user_id where lc.token_hash = $1",
        "incrementLoginChallengeAttempt": "update security.login_challenges set attempt_count = attempt_count + 1 where login_challenge_id = $1",
        "markLoginChallengeVerified": "update security.login_challenges set verified_at = now() where login_challenge_id = $1 and verified_at is null",

        "insertPasswordReset": "insert into security.password_resets (user_id, token_hash, token_sent_to, created_at, expires_at, request_ip, user_agent) values ($1, $2, $3, now(), now() + ($4 || ' seconds')::interval, $5, $6) returning password_reset_id as reset_id",
        "invalidateActivePasswordResetsForUser": "update security.password_resets set used_at = now() where user_id = $1 and used_at is null",
        "getPasswordResetByTokenHash": "select password_reset_id as reset_id, user_id, token_hash, expires_at, used_at, attempt_count from security.password_resets where token_hash = $1",
        "incrementPasswordResetAttempt": "update security.password_resets set attempt_count = attempt_count + 1 where password_reset_id = $1",
        "markPasswordResetUsed": "update security.password_resets set used_at = now() where password_reset_id = $1 and used_at is null",

        "insertOneTimeCode": "insert into security.one_time_codes (user_id, purpose, code_hash, created_at, expires_at, meta) values ($1, $2, $3, now(), now() + ($4 || ' seconds')::interval, $5::jsonb)",
        "consumeOneTimeCodesForUserPurpose": "update security.one_time_codes set consumed_at = now() where user_id = $1 and purpose = $2 and consumed_at is null",
        "getValidOneTimeCodeForPurpose": "select one_time_code_id as code_id, user_id, purpose, code_hash, expires_at, consumed_at, attempt_count, meta from security.one_time_codes where user_id = $1 and purpose = $2 and code_hash = $3 and consumed_at is null and expires_at > now() order by created_at desc limit 1",
        "getValidOneTimeCodeForPurposeAndTokenHash": "select one_time_code_id as code_id, user_id, purpose, code_hash, expires_at, consumed_at, attempt_count, meta from security.one_time_codes where purpose = $1 and (meta->>'tokenHash') = $2 and code_hash = $3 and consumed_at is null and expires_at > now() order by created_at desc limit 1",
        "getActiveOneTimeCodeForPurposeAndTokenHash": "select one_time_code_id as code_id, user_id, purpose, expires_at, consumed_at, attempt_count, meta from security.one_time_codes where purpose = $1 and (meta->>'tokenHash') = $2 and consumed_at is null order by created_at desc limit 1",
        "incrementOneTimeCodeAttempt": "update security.one_time_codes set attempt_count = attempt_count + 1 where one_time_code_id = $1",
        "consumeOneTimeCode": "update security.one_time_codes set consumed_at = now() where one_time_code_id = $1 and consumed_at is null",

        "updateUserPassword": "update security.users set password_hash = $2, updated_at = now() where user_id = $1",
        "loadPermissions": "select o.object_name as object_na, m.method_name as method_na, p.profile_id from security.permission_methods pm inner join security.profiles p on pm.profile_id = p.profile_id inner join security.methods m on m.method_id = pm.method_id inner join security.objects o on o.object_id = m.object_id",
        "loadDataTx": "select m.tx as tx_nu, o.object_name as object_na, m.method_name as method_na from security.methods m inner join security.objects o on m.object_id = o.object_id",

        "getNextTx": "select coalesce(max(m.tx), 0) + 1 as next_tx from security.methods m",

        "ensureObject": "with existing as (select object_id from security.objects where object_name = $1), ins as (insert into security.objects (object_name) select $1 where not exists (select 1 from existing) returning object_id) select object_id from ins union all select object_id from existing",

        "upsertMethodTx": "with existing_obj as (select object_id from security.objects where object_name = $1), ins_obj as (insert into security.objects (object_name) select $1 where not exists (select 1 from existing_obj) returning object_id), obj as (select object_id from ins_obj union all select object_id from existing_obj), existing_method as (select method_id from security.methods where object_id = (select object_id from obj) and method_name = $2), upd as (update security.methods set tx = $3 where method_id in (select method_id from existing_method) returning method_id), ins as (insert into security.methods (object_id, method_name, tx) select (select object_id from obj), $2, $3 where not exists (select 1 from existing_method) returning method_id) select method_id from upd union all select method_id from ins",

        "listObjects": "select object_id, object_name as object_na from security.objects order by object_name asc",
        "listProfiles": "select profile_id from security.profiles order by profile_id asc",
        "listMethodsByObject": "select m.method_id, o.object_name as object_na, m.method_name as method_na, m.tx as tx_nu from security.methods m inner join security.objects o on o.object_id = m.object_id where o.object_name = $1 order by m.tx asc nulls last, m.method_name asc",
        "listMethods": "select m.method_id, o.object_name as object_na, m.method_name as method_na, m.tx as tx_nu from security.methods m inner join security.objects o on o.object_id = m.object_id order by o.object_name asc, m.tx asc nulls last, m.method_name asc",
        "resolveMethodId": "select m.method_id, m.tx as tx_nu from security.methods m inner join security.objects o on o.object_id = m.object_id where o.object_name = $1 and m.method_name = $2",

        "grantPermission": "insert into security.permission_methods (profile_id, method_id) select $1, $2 where not exists (select 1 from security.permission_methods where profile_id = $1 and method_id = $2)",
        "revokePermission": "delete from security.permission_methods where profile_id = $1 and method_id = $2",
        "listPermissionsByProfile": "select p.profile_id, o.object_name as object_na, m.method_name as method_na, m.tx as tx_nu from security.permission_methods pm inner join security.profiles p on p.profile_id = pm.profile_id inner join security.methods m on m.method_id = pm.method_id inner join security.objects o on o.object_id = m.object_id where p.profile_id = $1 order by o.object_name asc, m.method_name asc",

        "deleteMethodByName": "delete from security.methods m using security.objects o where m.object_id = o.object_id and o.object_name = $1 and m.method_name = $2 returning m.method_id",
        "deleteObjectIfNoMethods": "delete from security.objects o where o.object_name = $1 and not exists (select 1 from security.methods m where m.object_id = o.object_id) returning o.object_id",

        "updateUserLastLogin": "update security.users set last_login_at = now(), updated_at = now() where user_id = $1",
        "insertAuditLog": "insert into security.audit_logs (request_id, user_id, profile_id, action, object_name, method_name, tx, meta) values ($1, $2, $3, $4, $5, $6, $7, $8::jsonb)"
    }
}
